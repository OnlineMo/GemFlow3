name: Daily DeepResearch

on:
  schedule:
    - cron: '0 16 * * *'  # 北京时间每日 00:00 运行（UTC+8 → UTC-8 差 16h）
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: daily-deepresearch
  cancel-in-progress: false

jobs:
  generate_report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('Flow/requirements.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Install Flow dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r Flow/requirements.txt

      - name: Build LangGraph API image
        working-directory: gemini-fullstack-langgraph-quickstart
        run: |
          docker build -t gemini-fullstack-langgraph -f Dockerfile .

      - name: Start engine via docker-compose
        working-directory: gemini-fullstack-langgraph-quickstart
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
        run: |
          docker-compose up -d

      - name: Wait for engine readiness
        run: |
          set -e
          echo "Waiting for engine http://localhost:8123 ..."
          for i in $(seq 1 40); do
            if curl -fsS http://localhost:8123/openapi.json >/dev/null 2>&1; then
              echo "Engine is ready"
              exit 0
            fi
            echo "Waiting... $i"
            sleep 3
          done
          echo "Engine failed to become ready" >&2
          docker ps -a || true
          exit 1

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Run daily workflow
        env:
          REPO_B_TOKEN: ${{ secrets.REPO_B_TOKEN }}
          REPO_B: owner/DeepResearch-Archive
          API_BASE_URL: http://localhost:8123
          TZ: Asia/Shanghai
        run: |
          python Flow/main_workflow.py

      - name: Show docker logs on failure
        if: failure()
        run: |
          docker ps -a || true
          docker logs langgraph-api || true
          docker logs langgraph-postgres || true
          docker logs langgraph-redis || true

      - name: Teardown docker
        if: always()
        working-directory: gemini-fullstack-langgraph-quickstart
        run: |
          docker-compose down -v || true